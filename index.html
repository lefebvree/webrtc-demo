<html>
	<head>
		<title>WebRTC Demo</title>
		<script src="/socket.io/socket.io.js"></script>
	</head>
	<body onload="showMyFace()">
		<video id="local" autoplay muted></video>
		<video id="remote" autoplay></video>

		<button onclick="showFriendsFace()" type="button">Call</button>

		<script>
			// Script based on websitebeaver.com
			// https://websitebeaver.com/insanely-simple-webrtc-video-chat-using-firebase-with-codepen-demo

			const localVideo = document.getElementById('local')
			const remoteVideo = document.getElementById('remote')

			const socket = io('//')

			const servers = {'iceServers': [{'urls': 'stun:stun.services.mozilla.com'}, {'urls': 'stun:stun.l.google.com:19302'}]}

			let pc = new RTCPeerConnection(servers)

			pc.onicecandidate = (event => event.candidate ? sendMessage({'ice': event.candidate}) : console.log("Sent All Ice"))
			pc.onaddstream = (event => remoteVideo.srcObject = event.stream)

			function sendMessage(data) {
				socket.emit('msg', data)
			}

			function readMessage(msg) {
				if (msg.ice != undefined) {
					pc.addIceCandidate(new RTCIceCandidate(msg.ice))
				} else if (msg.sdp.type == "offer") {
					pc.setRemoteDescription(new RTCSessionDescription(msg.sdp))
					.then(() => pc.createAnswer())
					.then(answer => pc.setLocalDescription(answer))
					.then(() => sendMessage({'sdp': pc.localDescription}))
				} else if (msg.sdp.type == "answer") {
					pc.setRemoteDescription(new RTCSessionDescription(msg.sdp))
				}
			}

			socket.on('msg', data => readMessage(data))

			function showMyFace() {
				navigator.mediaDevices.getUserMedia({audio: false, video: true})
				.then(stream => localVideo.srcObject = stream)
				.then(stream => pc.addStream(stream))
			}

			function showFriendsFace() {
				pc.createOffer()
				.then(offer => pc.setLocalDescription(offer))
				.then(() => sendMessage({'sdp': pc.localDescription }))
			}

		</script>
	</body>
</html>

